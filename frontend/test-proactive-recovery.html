<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Proactive Cross-Origin Recovery Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success { background: #dcfce7; border: 2px solid #22c55e; }
        .warning { background: #fef3c7; border: 2px solid #f59e0b; }
        .log {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .test-button { background: #10b981; }
        .test-button:hover { background: #059669; }
        .simulate-button { background: #f59e0b; }
        .simulate-button:hover { background: #d97706; }
    </style>
</head>
<body>
    <div class="container success">
        <h1>ğŸ”§ Proactive Cross-Origin Recovery Test</h1>
        <p><strong>ëª©ì :</strong> OAuth íŒì—…ì´ port 3000ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ë”ë¼ë„ 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ë³µêµ¬ë˜ì–´ íŒì—…ì´ ë‹«íˆëŠ”ì§€ í™•ì¸</p>
        
        <h3>ğŸ¯ ì˜ˆìƒ ì‹œë‚˜ë¦¬ì˜¤:</h3>
        <ol>
            <li>OAuth íŒì—… ì—´ë¦¼ (ì •ìƒ)</li>
            <li>OAuth ì„œë²„ê°€ port 3000ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì˜ëª»ëœ í¬íŠ¸)</li>
            <li>5ì´ˆ í›„ ì‹œìŠ¤í…œì´ port mismatch ê°ì§€</li>
            <li>ìë™ìœ¼ë¡œ cross-origin recovery ì‹¤í–‰</li>
            <li>ì„±ê³µì ìœ¼ë¡œ í† í° íšë“ ë° íŒì—… ìë™ ë‹«í˜</li>
        </ol>
    </div>

    <div class="container warning">
        <h2>âš ï¸ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤</h2>
        <p>ì´ í…ŒìŠ¤íŠ¸ëŠ” ì‹¤ì œ port mismatch ìƒí™©ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤:</p>
        <ul>
            <li>OAuth ë°ì´í„°ë¥¼ sessionStorageì— ë¯¸ë¦¬ ì €ì¥</li>
            <li>5ì´ˆ í›„ proactive recoveryê°€ íŠ¸ë¦¬ê±°ë˜ëŠ”ì§€ í™•ì¸</li>
            <li>íŒì—…ì´ ìë™ìœ¼ë¡œ ë‹«íˆëŠ”ì§€ í™•ì¸</li>
        </ul>
    </div>

    <div class="container">
        <button onclick="testProactiveRecovery()" class="test-button" id="testBtn">
            ğŸš€ Proactive Recovery í…ŒìŠ¤íŠ¸ ì‹œì‘
        </button>
        <button onclick="simulatePortMismatch()" class="simulate-button" id="simulateBtn">
            ğŸ­ Port Mismatch ì‹œë®¬ë ˆì´ì…˜
        </button>
        <button onclick="clearLogs()">Clear Logs</button>
        <button onclick="clearStorage()">Clear Storage</button>
    </div>

    <div class="container">
        <h2>ğŸ“Š í…ŒìŠ¤íŠ¸ ë¡œê·¸</h2>
        <div class="log" id="debug-log"></div>
    </div>

    <script>
        let testPopup = null;
        let testStartTime = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().split('.')[0];
            const logElement = document.getElementById('debug-log');
            const typeColors = {
                'info': '#00ff00',
                'warn': '#ffff00',
                'error': '#ff0000',
                'success': '#00ff88',
                'debug': '#88ff88',
                'test': '#ff88ff'
            };
            
            const logEntry = `[${timestamp}] ${message}\n`;
            logElement.innerHTML += `<span style="color: ${typeColors[type] || '#00ff00'}">${logEntry}</span>`;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearLogs() {
            document.getElementById('debug-log').innerHTML = '';
            log('ğŸ§¹ ë¡œê·¸ ì‚­ì œë¨', 'info');
        }

        function clearStorage() {
            const oauthKeys = Object.keys(sessionStorage).filter(key => key.includes('oauth'));
            oauthKeys.forEach(key => sessionStorage.removeItem(key));
            
            ['access_token', 'id_token', 'token_data'].forEach(key => {
                sessionStorage.removeItem(key);
            });
            
            log(`ğŸ§¹ OAuth ê´€ë ¨ storage í‚¤ ${oauthKeys.length + 3}ê°œ ì‚­ì œë¨`, 'info');
        }

        function simulatePortMismatch() {
            log('ğŸ­ Port mismatch ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘...', 'test');
            
            // Simulate OAuth completion data that would be stored by port 3000 callback
            const mockTokenData = {
                access_token: 'mock_access_token_' + Date.now(),
                token_type: 'Bearer',
                expires_in: 3600,
                scope: 'openid profile email',
                id_token: 'mock_id_token_' + Date.now(),
                timestamp: Date.now()
            };
            
            // Store data in various keys that the recovery mechanism checks
            sessionStorage.setItem('oauth_result', JSON.stringify({
                success: true,
                tokenData: mockTokenData
            }));
            
            sessionStorage.setItem('oauth_success', 'true');
            sessionStorage.setItem('oauth_token_data', JSON.stringify(mockTokenData));
            sessionStorage.setItem('oauth_access_token', mockTokenData.access_token);
            sessionStorage.setItem('oauth_completion_timestamp', Date.now().toString());
            
            log('âœ… Mock OAuth data stored in sessionStorage', 'success');
            log(`ğŸ“Š Stored keys: oauth_result, oauth_success, oauth_token_data, oauth_access_token, oauth_completion_timestamp`, 'debug');
            log('ğŸ¯ Now run the proactive recovery test to see if it detects this data', 'info');
        }

        async function testProactiveRecovery() {
            log('ğŸš€ Proactive Recovery í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'test');
            
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'ğŸ”„ í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘...';
            
            testStartTime = Date.now();
            
            try {
                // Clear any existing OAuth state first
                clearStorage();
                
                // Generate mock OAuth parameters
                const state = 'test_state_' + Date.now();
                const codeVerifier = 'test_verifier_' + Date.now();
                const nonce = 'test_nonce_' + Date.now();
                
                log('âœ… Mock OAuth íŒŒë¼ë¯¸í„° ìƒì„±ë¨', 'success');
                
                // Create mock flow state
                const flowId = 'proactive_test_' + Date.now();
                const flowState = {
                    state: state,
                    codeVerifier: codeVerifier,
                    nonce: nonce,
                    flowId: flowId,
                    flowType: 'popup',
                    clientId: 'maxlab',
                    redirectUri: `${window.location.origin}/oauth/callback`,
                    createdAt: Date.now(), // Important: This is used to calculate popup age
                    expiresAt: Date.now() + (15 * 60 * 1000),
                    parentOrigin: window.location.origin,
                    forceAccountSelection: false,
                    status: 'in_progress',
                    lastUpdated: Date.now()
                };
                
                // Store flow state
                sessionStorage.setItem(`oauth_flow_${flowId}`, JSON.stringify(flowState));
                sessionStorage.setItem('oauth_state', state);
                
                log(`âœ… Mock OAuth flow state created: ${flowId}`, 'success');
                
                // Open a test popup (blank page, just to simulate popup existence)
                testPopup = window.open('about:blank', 'proactive-test-popup', 'width=500,height=600');
                
                if (!testPopup) {
                    throw new Error('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
                
                log('âœ… í…ŒìŠ¤íŠ¸ íŒì—… ì—´ë¦¼', 'success');
                
                // Simulate the proactive recovery mechanism
                log('â±ï¸ 5ì´ˆ í›„ proactive recovery íŠ¸ë¦¬ê±°ë¥¼ ìœ„í•´ OAuth data ì €ì¥...', 'info');
                
                // Wait 2 seconds, then store OAuth data to simulate port 3000 completion
                setTimeout(() => {
                    log('ğŸ­ 2ì´ˆ í›„: Port 3000ì—ì„œ OAuth ì™„ë£Œ ì‹œë®¬ë ˆì´ì…˜...', 'test');
                    simulatePortMismatch();
                    
                    // Now wait for the proactive recovery to kick in (should happen at 5 seconds)
                    log('â³ 3ì´ˆ ë” ê¸°ë‹¤ë ¤ì„œ proactive recovery íŠ¸ë¦¬ê±° ì˜ˆìƒ...', 'info');
                    
                }, 2000);
                
                // Monitor for proactive recovery simulation
                let monitorCount = 0;
                const monitorInterval = setInterval(() => {
                    monitorCount++;
                    const elapsed = Date.now() - testStartTime;
                    
                    log(`ğŸ” ëª¨ë‹ˆí„°ë§ ${monitorCount}: ${elapsed}ms ê²½ê³¼`, 'debug');
                    
                    // Simulate the proactive recovery check (similar to the actual code)
                    if (elapsed > 5000) { // After 5 seconds
                        log('ğŸ¯ 5ì´ˆ ê²½ê³¼ - proactive recovery ì¡°ê±´ í™•ì¸...', 'test');
                        
                        // Check for OAuth data (same logic as the actual implementation)
                        const hasOAuthData = 
                            sessionStorage.getItem('oauth_result') ||
                            sessionStorage.getItem('oauth_success') ||
                            sessionStorage.getItem('oauth_token_data') ||
                            sessionStorage.getItem('oauth_access_token') ||
                            sessionStorage.getItem('oauth_completion_timestamp');
                        
                        if (hasOAuthData) {
                            log('âœ… OAuth data ë°œê²¬! Proactive recovery ì‹œë®¬ë ˆì´ì…˜...', 'success');
                            
                            // Simulate successful recovery
                            const mockRecoveredData = JSON.parse(sessionStorage.getItem('oauth_result'));
                            
                            log('ğŸ‰ Cross-origin recovery ì„±ê³µ ì‹œë®¬ë ˆì´ì…˜!', 'success');
                            log(`ğŸ“Š ë³µêµ¬ëœ í† í°: ${mockRecoveredData.tokenData.access_token.substring(0, 20)}...`, 'debug');
                            
                            // Close the test popup (simulating automatic closure)
                            if (testPopup && !testPopup.closed) {
                                testPopup.close();
                                log('ğŸšª íŒì—… ìë™ ë‹«í˜ ì‹œë®¬ë ˆì´ì…˜', 'success');
                            }
                            
                            clearInterval(monitorInterval);
                            
                            testBtn.disabled = false;
                            testBtn.textContent = 'ğŸš€ Proactive Recovery í…ŒìŠ¤íŠ¸ ì‹œì‘';
                            
                            log('ğŸŠ í…ŒìŠ¤íŠ¸ ì™„ë£Œ! Proactive recoveryê°€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.', 'success');
                            log(`â±ï¸ ì´ ì†Œìš” ì‹œê°„: ${elapsed}ms`, 'info');
                            
                        } else {
                            log('âŒ OAuth dataë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - recovery íŠ¸ë¦¬ê±°ë˜ì§€ ì•ŠìŒ', 'error');
                        }
                    }
                    
                    // Safety timeout after 15 seconds
                    if (elapsed > 15000) {
                        clearInterval(monitorInterval);
                        
                        if (testPopup && !testPopup.closed) {
                            testPopup.close();
                        }
                        
                        testBtn.disabled = false;
                        testBtn.textContent = 'ğŸš€ Proactive Recovery í…ŒìŠ¤íŠ¸ ì‹œì‘';
                        
                        log('â° í…ŒìŠ¤íŠ¸ íƒ€ì„ì•„ì›ƒ (15ì´ˆ)', 'warn');
                    }
                }, 1000);
                
            } catch (error) {
                log(`âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                
                testBtn.disabled = false;
                testBtn.textContent = 'ğŸš€ Proactive Recovery í…ŒìŠ¤íŠ¸ ì‹œì‘';
                
                if (testPopup && !testPopup.closed) {
                    testPopup.close();
                }
            }
        }

        // Initialize
        log('ğŸš€ Proactive Cross-Origin Recovery í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì´ˆê¸°í™”ë¨', 'success');
        log('ğŸ“‹ ì´ í…ŒìŠ¤íŠ¸ëŠ” OAuth íŒì—…ì´ port 3000ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ì–´ë„ 5ì´ˆ í›„ ìë™ ë³µêµ¬ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤', 'info');
        log('ğŸ¯ ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” popup monitoring intervalì´ ì´ ë¡œì§ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤', 'info');
    </script>
</body>
</html>