<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Callback Debug</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .log {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .info-box {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error-box {
            background: #fef2f2;
            border: 1px solid #ef4444;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success-box {
            background: #f0fdf4;
            border: 1px solid #22c55e;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }  
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        pre {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç OAuth Callback Debug Page</h1>
        <p>This page simulates the OAuth callback and tests popup communication.</p>
        
        <div id="status-box" class="info-box">
            <strong>Status:</strong> <span id="status">Initializing...</span>
        </div>

        <div>
            <button onclick="testPopupDetection()">Test Popup Detection</button>
            <button onclick="testMessageSending()">Test Message Sending</button>
            <button onclick="simulateOAuthSuccess()">Simulate OAuth Success</button>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>

        <h3>Debug Information</h3>
        <div id="debug-info"></div>

        <h3>Live Debug Log</h3>
        <div class="log" id="debug-log"></div>
    </div>

    <script>
        // Debug logging
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().split('.')[0];
            const logElement = document.getElementById('debug-log');
            const typeColors = {
                'info': '#00ff00',
                'warn': '#ffff00', 
                'error': '#ff0000',
                'success': '#00ff88',
                'debug': '#88ff88'
            };
            
            const logEntry = `[${timestamp}] ${message}\n`;
            logElement.innerHTML += `<span style="color: ${typeColors[type] || '#00ff00'}">${logEntry}</span>`;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(message);
        }

        // Update status
        function setStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            const statusBox = document.getElementById('status-box');
            statusEl.textContent = message;
            
            statusBox.className = `${type}-box`;
        }

        // Simulate isPopupMode detection
        function isPopupMode() {
            log('üîç Testing popup mode detection...', 'info');
            
            const urlParams = new URLSearchParams(window.location.search);
            const state = urlParams.get('state');
            
            log(`URL State: ${state || 'none'}`, 'debug');
            log(`Session oauth_popup_mode: ${sessionStorage.getItem('oauth_popup_mode')}`, 'debug');
            log(`Session oauth_force_account_selection: ${sessionStorage.getItem('oauth_force_account_selection')}`, 'debug');
            log(`Window opener exists: ${!!window.opener}`, 'debug');
            log(`Window parent !== window: ${window.parent !== window}`, 'debug');
            log(`Window size: ${window.innerWidth}x${window.innerHeight}`, 'debug');
            log(`Window name: ${window.name || 'none'}`, 'debug');
            log(`Document referrer: ${document.referrer || 'none'}`, 'debug');
            
            // Test each detection method
            let detected = false;
            let method = '';

            // Method 1: SessionStorage
            if (sessionStorage.getItem('oauth_popup_mode') === 'true') {
                detected = true;
                method = 'sessionStorage oauth_popup_mode';
                log('‚úÖ Popup detected via sessionStorage oauth_popup_mode', 'success');
            }

            // Method 2: Window opener
            if (window.opener !== null && window.opener !== window) {
                detected = true;
                method = method ? method + ', window.opener' : 'window.opener';
                log('‚úÖ Popup detected via window.opener', 'success');
            }

            // Method 3: Window size heuristic
            if (window.innerWidth <= 600 && window.innerHeight <= 800) {
                detected = true;
                method = method ? method + ', window size' : 'window size';
                log('‚úÖ Popup detected via window size heuristic', 'success');
            }

            // Method 4: URL parameters
            if (urlParams.get('popup') === 'true') {
                detected = true;
                method = method ? method + ', URL param' : 'URL param';
                log('‚úÖ Popup detected via URL parameter', 'success');
            }

            // Method 5: Force account selection flag
            if (sessionStorage.getItem('oauth_force_account_selection') === 'true') {
                detected = true;
                method = method ? method + ', force account selection' : 'force account selection';
                log('‚úÖ Popup detected via force account selection flag', 'success');
            }

            if (!detected) {
                log('‚ùå Popup mode NOT detected by any method', 'error');
                method = 'none';
            }

            return { detected, method };
        }

        // Test popup detection
        function testPopupDetection() {
            log('üîç Running popup detection test...', 'info');
            const result = isPopupMode();
            
            if (result.detected) {
                setStatus(`Popup detected via: ${result.method}`, 'success');
                log(`‚úÖ Popup detection successful: ${result.method}`, 'success');
            } else {
                setStatus('Popup NOT detected', 'error');
                log('‚ùå Popup detection failed', 'error');
            }
        }

        // Test message sending
        function testMessageSending() {
            log('üì§ Testing message sending capabilities...', 'info');
            
            let messagesSent = 0;
            let messagesSuccessful = 0;

            // Method 1: PostMessage to opener
            if (window.opener && window.opener !== window) {
                try {
                    const testMessage = {
                        type: 'TEST_MESSAGE',
                        timestamp: Date.now(),
                        message: 'Test from popup callback'
                    };
                    
                    window.opener.postMessage(testMessage, '*');
                    messagesSent++;
                    messagesSuccessful++;
                    log('‚úÖ PostMessage to opener sent successfully', 'success');
                } catch (e) {
                    messagesSent++;
                    log(`‚ùå PostMessage to opener failed: ${e.message}`, 'error');
                }
            } else {
                log('‚ö†Ô∏è No window.opener available for PostMessage', 'warn');
            }

            // Method 2: PostMessage to parent
            if (window.parent && window.parent !== window) {
                try {
                    const testMessage = {
                        type: 'TEST_MESSAGE',
                        timestamp: Date.now(),
                        message: 'Test from popup callback to parent'
                    };
                    
                    window.parent.postMessage(testMessage, '*');
                    messagesSent++;
                    messagesSuccessful++;
                    log('‚úÖ PostMessage to parent sent successfully', 'success');
                } catch (e) {
                    messagesSent++;
                    log(`‚ùå PostMessage to parent failed: ${e.message}`, 'error');
                }
            } else {
                log('‚ö†Ô∏è No window.parent available for PostMessage', 'warn');
            }

            // Method 3: BroadcastChannel
            try {
                const channel = new BroadcastChannel('oauth_channel');
                const testMessage = {
                    type: 'TEST_MESSAGE',
                    timestamp: Date.now(),
                    message: 'Test from popup callback via BroadcastChannel'
                };
                
                channel.postMessage(testMessage);
                channel.close();
                messagesSent++;
                messagesSuccessful++;
                log('‚úÖ BroadcastChannel message sent successfully', 'success');
            } catch (e) {
                messagesSent++;
                log(`‚ùå BroadcastChannel failed: ${e.message}`, 'error');
            }

            // Method 4: SessionStorage
            try {
                const testData = {
                    type: 'TEST_MESSAGE',
                    timestamp: Date.now(),
                    message: 'Test from popup callback via SessionStorage'
                };
                
                sessionStorage.setItem('test_oauth_result', JSON.stringify(testData));
                messagesSent++;
                messagesSuccessful++;
                log('‚úÖ SessionStorage message stored successfully', 'success');
            } catch (e) {
                messagesSent++;
                log(`‚ùå SessionStorage failed: ${e.message}`, 'error');
            }

            log(`üìä Message sending summary: ${messagesSuccessful}/${messagesSent} successful`, 'info');
            setStatus(`Message test: ${messagesSuccessful}/${messagesSent} methods successful`, messagesSuccessful > 0 ? 'success' : 'error');
        }

        // Simulate OAuth success
        function simulateOAuthSuccess() {
            log('üéØ Simulating OAuth success response...', 'info');
            
            const tokenData = {
                access_token: 'test_access_token_' + Date.now(),
                token_type: 'Bearer',
                expires_in: 3600,
                scope: 'openid profile email',
                refresh_token: 'test_refresh_token_' + Date.now(),
                id_token: 'test_id_token_' + Date.now()
            };

            const successMessage = {
                type: 'OAUTH_SUCCESS',
                token: tokenData.access_token,
                tokenData: tokenData,
                timestamp: Date.now()
            };

            log(`üìä Token data: ${JSON.stringify(tokenData, null, 2)}`, 'debug');

            let sentCount = 0;
            let successCount = 0;

            // Send via all available methods
            
            // PostMessage to opener
            if (window.opener && window.opener !== window) {
                try {
                    window.opener.postMessage(successMessage, '*');
                    sentCount++;
                    successCount++;
                    log('‚úÖ OAuth success sent via PostMessage to opener', 'success');
                } catch (e) {
                    sentCount++;
                    log(`‚ùå PostMessage to opener failed: ${e.message}`, 'error');
                }
            }

            // PostMessage to parent
            if (window.parent && window.parent !== window) {
                try {
                    window.parent.postMessage(successMessage, '*');
                    sentCount++;
                    successCount++;
                    log('‚úÖ OAuth success sent via PostMessage to parent', 'success');
                } catch (e) {
                    sentCount++;
                    log(`‚ùå PostMessage to parent failed: ${e.message}`, 'error');
                }
            }

            // BroadcastChannel
            try {
                const channel = new BroadcastChannel('oauth_channel');
                channel.postMessage(successMessage);
                channel.close();
                sentCount++;
                successCount++;
                log('‚úÖ OAuth success sent via BroadcastChannel', 'success');
            } catch (e) {
                sentCount++;
                log(`‚ùå BroadcastChannel failed: ${e.message}`, 'error');
            }

            // SessionStorage (multiple keys for better detection)
            const storageKeys = ['oauth_result', 'oauth_success', 'oauth_token_data'];
            for (const key of storageKeys) {
                try {
                    sessionStorage.setItem(key, JSON.stringify(successMessage));
                    sentCount++;
                    successCount++;
                    log(`‚úÖ OAuth success stored in sessionStorage key: ${key}`, 'success');
                } catch (e) {
                    sentCount++;
                    log(`‚ùå SessionStorage key ${key} failed: ${e.message}`, 'error');
                }
            }

            // Individual token storage
            try {
                sessionStorage.setItem('oauth_access_token', tokenData.access_token);
                sessionStorage.setItem('oauth_completion_timestamp', Date.now().toString());
                sentCount++;
                successCount++;
                log('‚úÖ Individual token data stored', 'success');
            } catch (e) {
                sentCount++;
                log(`‚ùå Individual token storage failed: ${e.message}`, 'error');
            }

            log(`üìä OAuth success simulation: ${successCount}/${sentCount} methods successful`, 'info');
            setStatus(`OAuth success sent via ${successCount}/${sentCount} methods`, successCount > 0 ? 'success' : 'error');

            // If we're in a popup, try to close after a delay
            const popupResult = isPopupMode();
            if (popupResult.detected) {
                log('üö™ Attempting to close popup in 2 seconds...', 'info');
                setTimeout(() => {
                    try {
                        window.close();
                        log('‚úÖ Popup close attempted', 'success');
                    } catch (e) {
                        log(`‚ùå Popup close failed: ${e.message}`, 'error');
                    }
                }, 2000);
            }
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('debug-log').innerHTML = '';
            log('üßπ Debug logs cleared', 'info');
        }

        // Display debug information
        function displayDebugInfo() {
            const debugInfo = {
                'Window Properties': {
                    'opener exists': !!window.opener,
                    'parent is different': window.parent !== window,
                    'window name': window.name || 'none',
                    'window size': `${window.innerWidth}x${window.innerHeight}`,
                    'location': window.location.href,
                    'referrer': document.referrer || 'none'
                },
                'URL Parameters': Object.fromEntries(new URLSearchParams(window.location.search)),
                'SessionStorage OAuth Keys': Object.keys(sessionStorage).filter(k => k.includes('oauth')).reduce((obj, key) => {
                    obj[key] = sessionStorage.getItem(key);
                    return obj;
                }, {}),
                'LocalStorage Auth Keys': Object.keys(localStorage).filter(k => k.includes('auth') || k.includes('token')).reduce((obj, key) => {
                    obj[key] = localStorage.getItem(key);
                    return obj;
                }, {})
            };

            let html = '';
            for (const [category, data] of Object.entries(debugInfo)) {
                html += `<h4>${category}</h4><pre>${JSON.stringify(data, null, 2)}</pre>`;
            }

            document.getElementById('debug-info').innerHTML = html;
        }

        // Initialize
        log('üöÄ OAuth Callback Debug initialized', 'info');
        setStatus('Debug page loaded', 'success');
        displayDebugInfo();

        // Auto-run tests if this looks like a popup
        setTimeout(() => {
            if (window.opener || window.innerWidth <= 600) {
                log('üîç Auto-running popup detection (appears to be in popup)...', 'info');
                testPopupDetection();
            }
        }, 1000);
    </script>
</body>
</html>