<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Port 3000 Handler</title>
    <script>
        // ì´ í˜ì´ì§€ëŠ” localhost:3000ì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤
        // OAuth ì„œë²„ê°€ ì˜ëª» ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ëŠ” ê²½ìš°ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤
        
        console.log('ğŸ”§ OAuth Port 3000 Handler loaded');
        console.log('ğŸ“ Current location:', window.location.href);
        
        // URLì—ì„œ OAuth íŒŒë¼ë¯¸í„° ì¶”ì¶œ
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        
        if (code && state) {
            console.log('âœ… OAuth authorization code received:', code.substring(0, 10) + '...');
            
            // OAuth ë°ì´í„°ë¥¼ storageì— ì €ì¥ (cross-origin recoveryê°€ ì°¾ì„ ìˆ˜ ìˆë„ë¡)
            const oauthResult = {
                success: true,
                code: code,
                state: state,
                timestamp: Date.now(),
                origin: 'port-3000-handler'
            };
            
            // ì—¬ëŸ¬ storage keysì— ì €ì¥í•˜ì—¬ recovery í™•ë¥  ë†’ì´ê¸°
            sessionStorage.setItem('oauth_result', JSON.stringify(oauthResult));
            sessionStorage.setItem('oauth_success', 'true');
            sessionStorage.setItem('oauth_code', code);
            sessionStorage.setItem('oauth_state', state);
            sessionStorage.setItem('oauth_completion_timestamp', Date.now().toString());
            
            console.log('ğŸ’¾ OAuth data saved to sessionStorage');
            
            // Port 3010ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ ì‹œë„
            try {
                // BroadcastChannelë¡œ ì „ì†¡
                const channel = new BroadcastChannel('oauth_channel');
                channel.postMessage({
                    type: 'OAUTH_SUCCESS',
                    code: code,
                    state: state,
                    source: 'port-3000-handler'
                });
                console.log('ğŸ“¡ Sent OAuth success via BroadcastChannel');
                
                // PostMessageë¡œë„ ì „ì†¡ (ì—¬ëŸ¬ origin ì‹œë„)
                const targetOrigins = [
                    'http://localhost:3010',
                    'http://localhost:3011',
                    'http://localhost:3012',
                    '*' // ìµœí›„ì˜ ìˆ˜ë‹¨
                ];
                
                for (const origin of targetOrigins) {
                    try {
                        if (window.opener) {
                            window.opener.postMessage({
                                type: 'OAUTH_SUCCESS',
                                code: code,
                                state: state,
                                source: 'port-3000-handler'
                            }, origin);
                            console.log(`ğŸ“¤ Sent OAuth success to opener with origin: ${origin}`);
                        }
                    } catch (e) {
                        console.warn(`Failed to send to origin ${origin}:`, e);
                    }
                }
                
            } catch (e) {
                console.error('Failed to send OAuth data:', e);
            }
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px; font-family: system-ui;">
                    <h2>âœ… ë¡œê·¸ì¸ ì„±ê³µ!</h2>
                    <p>ì´ ì°½ì€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤...</p>
                    <p style="color: #666; font-size: 14px;">OAuth code: ${code.substring(0, 10)}...</p>
                </div>
            `;
            
            // 2ì´ˆ í›„ ì°½ ë‹«ê¸°
            setTimeout(() => {
                window.close();
            }, 2000);
            
        } else if (error) {
            console.error('âŒ OAuth error:', error);
            
            // ì—ëŸ¬ ì •ë³´ ì €ì¥
            sessionStorage.setItem('oauth_error', error);
            sessionStorage.setItem('oauth_error_description', urlParams.get('error_description') || '');
            
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px; font-family: system-ui;">
                    <h2>âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨</h2>
                    <p>${error}: ${urlParams.get('error_description') || ''}</p>
                </div>
            `;
            
            setTimeout(() => {
                window.close();
            }, 3000);
            
        } else {
            console.log('âš ï¸ No OAuth parameters found in URL');
            
            // ì¼ë°˜ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë³´ì´ë„ë¡
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px; font-family: system-ui;">
                    <h1>MAX Platform</h1>
                    <p>ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...</p>
                </div>
            `;
        }
    </script>
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: system-ui;">
        <h1>OAuth ì²˜ë¦¬ ì¤‘...</h1>
        <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    </div>
</body>
</html>